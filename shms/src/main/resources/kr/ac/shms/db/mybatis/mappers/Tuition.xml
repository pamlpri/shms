<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.ac.shms.lms.student.dao.TuitionDAO">
	<select id="selectTuitionList" parameterType="String" resultType="TuitionVO">
		SELECT DISTINCT pay_year,
		       pay_semstr,
		       (SELECT reginfo_stat FROM v_stdntinfo WHERE stdnt_no=#{stdnt_no}) reginfo_stat,
		       TO_CHAR(pay_amt, '999,999,999') pay_amt,
		       TO_CHAR(pay_dt, 'RRRR/MM/DD') pay_dt,
		       TO_CHAR(c.reg_amt, '999,999,999') reg_amt,
		       NVL(TO_CHAR(reciv_amt, '999,999,999'),0) schl
		  FROM reg_fee_pay a
		 INNER JOIN student b ON(a.stdnt_no=b.stdnt_no)
		 INNER JOIN subject c ON(b.sub_code=c.sub_code)
		 LEFT OUTER JOIN schl_req d ON(a.stdnt_no=d.stdnt_no)
		 LEFT OUTER JOIN reciv_schl e ON(d.req_no=e.req_no)
		 WHERE a.stdnt_no=#{stdnt_no, jdbcType=VARCHAR}
		 ORDER BY pay_year asc
	</select>
	
	<select id="selectTuitionBill" parameterType="String" resultType="TuitionVO">
		SELECT DISTINCT b.sub_name,
		       grade, 
		       a.stdnt_no, 
		       name,
		       TO_CHAR(b.reg_amt, '999,999,999') reg_amt,
       		   TO_CHAR(d.reciv_amt, '999,999,999') reciv_amt,
       		   TO_CHAR((b.reg_amt - d.reciv_amt), '999,999,999') tuition,
		       EXTRACT(YEAR FROM SYSDATE) year
		  FROM student a
		 INNER JOIN subject b ON(a.sub_code=b.sub_code)
		 INNER JOIN schl_req c ON(a.stdnt_no=c.stdnt_no)
		 INNER JOIN reciv_schl d ON(c.req_no=d.req_no)
		 WHERE a.stdnt_no=#{stdnt_no, jdbcType=VARCHAR}
		   AND EXTRACT(YEAR FROM c.req_de) =EXTRACT(YEAR FROM SYSDATE)
		   AND a.semstr = (SELECT semstr FROM v_semstr)
	</select>
	<select id="selectTuitionPaySchdule" resultType="ScheduleVO">
		SELECT title,
		       TO_NUMBER(TO_CHAR(begin_dt, 'YYYY')) year,
		       EXTRACT(MONTH FROM begin_dt) start_month,
		       EXTRACT(DAY FROM begin_dt) start_day,
		       EXTRACT(DAY FROM end_dt) end_day
		  FROM schedule a
		 WHERE title = TO_CHAR(EXTRACT(YEAR FROM SYSDATE))||'학년도 '||        
	    		TO_CHAR((SELECT semstr FROM v_semstr))||'학기 등록금 수납 기간'
	</select>
	<select id="selectTuitionReceipt" parameterType="String" resultType="TuitionVO">
		SELECT DISTINCT b.sub_name,
		       a.grade,
		       a.stdnt_no,
		       a.name,
		       TO_CHAR(b.reg_amt, '999,999,999') reg_amt,
		       TO_CHAR(d.reciv_amt, '999,999,999') reciv_amt,
		       TO_CHAR(c.pay_amt, '999,999,999') pay_amt,
		       c.pay_dt,
		       EXTRACT(YEAR FROM c.pay_dt) year,
		       EXTRACT(MONTH FROM c.pay_dt) month,
		       EXTRACT(DAY FROM c.pay_dt) day
		  FROM student a
		 INNER JOIN subject b ON(a.sub_code=b.sub_code)
		 INNER JOIN reg_fee_pay c ON(a.stdnt_no=c.stdnt_no)
		 INNER JOIN schl_req c ON(a.stdnt_no=c.stdnt_no)
		 INNER JOIN reciv_schl d ON(c.req_no=d.req_no)
		 WHERE a.stdnt_no=#{stdnt_no, jdbcType=VARCHAR}
		   AND EXTRACT(YEAR FROM c.pay_dt) =EXTRACT(YEAR FROM SYSDATE)
<!-- 		   AND EXTRACT(YEAR FROM c.pay_dt) = 2020 -->
		   AND pay_semstr = (SELECT semstr FROM V_SEMSTR)
	</select>
	
	<select id="selectRefundResn" resultType="ComCodeVO">
		 SELECT com_code_nm,
		        com_code
		   FROM tb_com_code
		  WHERE CODE_GRP = (SELECT CODE_GRP FROM TB_CODE_GRP WHERE CODE_GRP_NM = 'REQ_RESN_CODE')
	</select>
	
	<select id="selectRefundAmt" resultType="String" parameterType="String">
		<![CDATA[
		SELECT CASE WHEN SYSDATE-startHG <= 30 THEN TO_CHAR(FLOOR(pay_amt*5/6), '999,999,999')
		            WHEN SYSDATE-startHG > 30 and SYSDATE-startHG <= 60 THEN TO_CHAR(FLOOR(pay_amt*2/3), '999,999,999')
		            WHEN SYSDATE-startHG > 60 AND SYSDATE-startHG <= 90 THEN TO_CHAR(FLOOR(pay_amt*1/2), '999,999,999')
		       END AS refund
		  FROM(
		SELECT pay_amt,
		       pay_dt,
		       (SELECT begin_dt
		          FROM schedule a
		         WHERE title = TO_CHAR(EXTRACT(YEAR FROM SYSDATE))||'학년도 '||        
		            TO_CHAR((SELECT semstr FROM v_semstr))||'학기 등록금 수납 기간') startHG
		  FROM reg_fee_pay 
		 WHERE stdnt_no=#{stdnt_no, jdbcType=VARCHAR}
		   AND pay_year=EXTRACT(YEAR FROM SYSDATE)
		   AND pay_semstr=(SELECT semstr FROM v_semstr))
		   ]]>
	</select>
</mapper>
