<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.ac.shms.lecture.dao.LectureDAO">

	<select id="selectStudentSugangList" parameterType="String" resultType="SugangLecSTVO">
		SELECT
		    stdnt_no,
         	stdnt_name,
    		grade,
		    semstr,
		    lec_name,
		    prof_name,
		    (SELECT com_code_nm
		       FROM tb_com_code
		      WHERE CODE_GRP = (SELECT CODE_GRP FROM TB_CODE_GRP WHERE CODE_GRP_NM = 'LEC_CL')
		       AND 	com_code = lec_cl) lec_cl,
		  	     estbl_year,
		    estbl_semstr,
		    lecrum,
		    lec_code,
		    lec_pnt,
		    sugang_at,
		    req_year,
		    estbl_year
			  FROM
			(
			SELECT DISTINCT
			       a.stdnt_no,
			       a.name stdnt_name,
			       a.grade,
			       a.semstr,
			       d.lec_name,
			       e.name prof_name,
			       d.lec_cl,
			       c.estbl_year,
			       c.estbl_semstr,
			       h.building_nm||' '||g.lecrum_nm||'호' lecrum,
			       c.lec_code,
			       d.lec_pnt,
			       b.sugang_at,
			       b.req_year
			  FROM student A
			  INNER JOIN sugang_req b
			  ON (a.stdnt_no = b.stdnt_no)
			  INNER JOIN lecture c
			  ON (b.lec_code = c.lec_code)
			  INNER JOIN curriculum d
			  ON (c.cur_code = d.cur_code)
			  INNER JOIN staff e
			  ON (d.staff_no = e.staff_no)
			  INNER JOIN lecrum_ttable f
			  ON (c.lec_code = f.lec_code)
			  INNER JOIN lecrum g
			  ON (f.lecrum_no = g.lecrum_no)
			  INNER JOIN building h
			  ON(g.building_no = h.building_no)
			)
<!-- 		WHERE ESTBL_YEAR = EXTRACT(YEAR FROM SYSDATE) -->
	     WHERE stdnt_no = #{stdnt_no, jdbcType=VARCHAR}   
	       AND sugang_at = 'Y'
	       AND req_year = 2019        
	       AND estbl_year = 2019
	       AND ESTBL_SEMSTR = (SELECT  CASE WHEN EXTRACT(MONTH FROM SYSDATE) BETWEEN 2 AND 7 THEN  1
	                                  ELSE 2
	                                  END AS SEMSTR
	                            FROM DUAL)
	</select>
	<select id="selectLectureDetails" parameterType="String" resultType="LectureDetailsVO">
		SELECT a.lec_code, 
		       d.lec_name, 
		       a.summary, 
		       b.midterm * 100 midterm, 
               b.finals * 100 finals, 
               b.attend * 100 attend, 
               b.task * 100 task, 
		       b.etc,
		       c.lec_week, 
		       c.week_bgnde, 
		       c.week_endde, 
		       c.diary_title,
		       c.diary_cont
	      FROM lecture a
	     INNER JOIN lec_score_st b ON (a.lec_code=b.lec_code)
	     INNER JOIN lec_week_diary c ON (b.lec_code=c.lec_code)
	     INNER JOIN curriculum d ON (a.cur_code=d.cur_code)
	     WHERE a.lec_code= #{lec_code, jdbcType=VARCHAR}
<!-- 	       AND c.lec_week = TO_CHAR(SYSDATE,'W') -->
<!-- 	         AND a.estbl_year = EXTRACT(YEAR FROM SYSDATE) -->
<!-- 		   AND a.estbl_year='2013' -->
	</select>
	<select id="selectProfessorSugangList" parameterType="String" resultType="SugangLecPRVO">
	SELECT name,
	       staff_no,
	       lec_name,
	       lec_pnt,
	       lec_atnlc,
	       (SELECT com_code_nm
	          FROM tb_com_code
	         WHERE CODE_GRP = (SELECT CODE_GRP FROM TB_CODE_GRP WHERE CODE_GRP_NM = 'LEC_CL')
	           AND com_code = lec_cl) lec_cl,
	       lec_code,
	       lecrum,
	       estbl_year
	  FROM (
	        SELECT DISTINCT a.name, 
	               a.staff_no, 
	               b.lec_name, 
	               b.lec_pnt,
	               b.lec_atnlc,
	               c.lec_code,
	               c.lec_cl,
	               f.building_nm||' '||e.lecrum_nm||'호' lecrum,
	               b.estbl_year
	          FROM staff a
	         INNER JOIN curriculum b ON (a.staff_no=b.staff_no)
	         INNER JOIN lecture c ON (b.cur_code=c.cur_code)
	         RIGHT OUTER JOIN lecrum_ttable d ON (c.lec_code = d.lec_code)
	         RIGHT OUTER JOIN lecrum e ON (d.lecrum_no = e.lecrum_no)
	        RIGHT OUTER JOIN building f ON (f.building_no = e.building_no)
	       )
	 WHERE staff_no=#{staff_no, jdbcType=VARCHAR}
	</select>
	
	<sql id="myLecFrag">
	    FROM sugang_req
	   WHERE stdnt_no = #{stdnt_no, jdbcType=VARCHAR}
	     AND sugang_at = 'Y'
	     AND req_year = EXTRACT(MONTH FROM SYSDATE)
	     AND req_semstr = (SELECT SEMSTR FROM STUDENT WHERE STDNT_NO = #{stdnt_no, jdbcType=VARCHAR})
	</sql>
	
	<select id="selectTask" parameterType="String" resultType="kr.ac.shms.lecture.vo.SetTaskVO">
		SELECT 
		    a.p_bo_no,
		    a.set_task_no,
		    lec_code,
		    task_reg_de,
		    submit_bgnde,
		    submit_endde,
		    task_title,
		    task_cont,
		    task_allot,
		    atch_file_no,
		    DECODE(b.writer, null, 'N', 'Y') submit_at
		  FROM (
		SELECT
		    ROW_NUMBER () OVER (ORDER BY task_reg_de) p_bo_no,
		    set_task_no,
		    lec_code,
		    TO_CHAR(task_reg_de, 'YYYY.MM.DD') task_reg_de,
		    TO_CHAR(submit_bgnde, 'YYYY.MM.DD') submit_bgnde,
		    TO_CHAR(submit_endde, 'YYYY.MM.DD') submit_endde,
		    task_title,
		    task_cont,
		    task_allot,
		    atch_file_no
		FROM
		    set_task 
		   WHERE lec_code IN (
		  SELECT lec_code
		  	<include refid="myLecFrag"/>
		    )) a
		    LEFT OUTER JOIN(
		     SELECT writer, set_task_no
		       FROM task_submit
		      WHERE writer = (SELECT NAME FROM STUDENT WHERE STDNT_NO = #{stdnt_no, jdbcType=VARCHAR})
		    ) b
		    ON(a.set_task_no = b.set_task_no)
		ORDER BY p_bo_no desc
	</select>
	
	<select id="selectTodayLecList" parameterType="String" resultType="LectureDetailsVO">
 		SELECT lec_code,
	         LPAD(lec_time, 2, '0')||':00 - '||
	         LPAD(lec_time + lec_pnt, 2, '0')||':00' lec_time,
	         lec_name
	    FROM lecture a
	   INNER JOIN curriculum b
	      ON (a.cur_code = b.cur_code)
	   WHERE lec_code IN (
	  SELECT lec_code
		<include refid="myLecFrag"/>
	     AND TO_NUMBER(dayotw) = (SELECT TO_CHAR(SYSDATE, 'D') FROM DUAL))
	</select>

	<select id="selectCompleteSugangList" parameterType="String" resultType="SugangLecSTVO">
	SELECT
	    stdnt_no,
	    stdnt_name,
	    grade,
	    semstr,
	    lec_name,
	    prof_name,
	    (SELECT com_code_nm
	       FROM tb_com_code
	      WHERE CODE_GRP = (SELECT CODE_GRP FROM TB_CODE_GRP WHERE CODE_GRP_NM = 'LEC_CL')
	       AND 	com_code = lec_cl) lec_cl,
	  	     estbl_year,
	    estbl_semstr,
	    lecrum,
	    lec_code,
	    lec_pnt,
	    req_year
	  FROM
	(
	SELECT DISTINCT
	       a.stdnt_no,
	       a.name stdnt_name,
	       a.grade,
	       a.semstr,
	       d.lec_name,
	       e.name prof_name,
	       d.lec_cl,
	       c.estbl_year,
	       c.estbl_semstr,
	       h.building_nm||' '||g.lecrum_nm||'호' lecrum,
	       c.lec_code,
	       d.lec_pnt,
	       b.req_year
	  FROM STUDENT A
	  INNER JOIN SUGANG_REQ B
	  ON (A.STDNT_NO = B.STDNT_NO)
	  INNER JOIN LECTURE C
	  ON (B.LEC_CODE = C.LEC_CODE)
	  INNER JOIN CURRICULUM D
	  ON (C.CUR_CODE = D.CUR_CODE)
	  INNER JOIN STAFF E
	  ON (D.STAFF_NO = E.STAFF_NO)
	  INNER JOIN LECRUM_TTABLE F
	  ON (C.LEC_CODE = F.LEC_CODE)
	  INNER JOIN LECRUM G
	  ON (F.LECRUM_NO = G.LECRUM_NO)
	  INNER JOIN BUILDING H
	  ON(G.BUILDING_NO = H.BUILDING_NO)
	)
	 WHERE ESTBL_YEAR NOT IN EXTRACT(YEAR FROM SYSDATE) 
	   AND ESTBL_SEMSTR = (SELECT  CASE WHEN EXTRACT(MONTH FROM SYSDATE) BETWEEN 2 AND 7 THEN  2
	                              ELSE 1
	                              END AS SEMSTR
	                        FROM DUAL) 
	   AND stdnt_no = #{stdnt_no, jdbcType=VARCHAR} 
	   AND req_year NOT IN EXTRACT(YEAR FROM SYSDATE)
	</select>
</mapper>