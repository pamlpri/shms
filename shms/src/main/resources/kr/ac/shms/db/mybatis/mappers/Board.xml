<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.ac.shms.main.commuity.dao.BoardDAO">

	<select id="selectBoKind" parameterType="string" resultType="string">
		SELECT com_code
		  FROM tb_com_code
		WHERE code_grp = (SELECT code_grp FROM tb_code_grp WHERE code_grp_nm = 'BO_KIND') 
		  AND com_code_nm = #{bo_name, jdbcType=VARCHAR}
	</select>
	
	<select id="selectForMain" parameterType="hashMap" resultType="BoardVO">
		SELECT * 
		  FROM(
		SELECT
		    (SELECT COUNT(*)
		      FROM board
		      WHERE bo_kind = (SELECT com_code
		                  FROM tb_com_code
		                WHERE code_grp = (SELECT code_grp FROM tb_code_grp WHERE code_grp_nm = 'BO_KIND') 
		                  AND com_code_nm = #{bo_name, jdbcType=VARCHAR}))
		      - (ROW_NUMBER () OVER (ORDER BY bo_write_de DESC)) + 1 p_bo_no,
		    ROW_NUMBER () OVER (ORDER BY bo_write_de DESC) rn,
		    bo_no,
		    bo_kind,
		    bo_title,
		    TO_CHAR(bo_write_de, 'YYYY.MM.DD') bo_write_de,
		    bo_hit
		FROM
		    board
		WHERE bo_kind = (SELECT com_code
		                  FROM tb_com_code
		                WHERE code_grp = (SELECT code_grp FROM tb_code_grp WHERE code_grp_nm = 'BO_KIND') 
		                  AND com_code_nm = #{bo_name, jdbcType=VARCHAR})
		 <if test="@org.apache.commons.lang3.StringUtils@isNotBlank(sub)">
		 	AND SUB_CODE = #{sub, jdbcType=VARCHAR}
		 </if>
		)
		<![CDATA[
		WHERE RN <= 5		
		]]>
	</select>
	
	<sql id="searchFrag">
		<if test="searchMap!=null and @org.apache.commons.lang3.StringUtils@isNotBlank(searchMap.searchWord)">
			<choose>
				<when test="searchMap.searchType eq 'title'">
					INSTR(bo_title, #{searchMap.searchWord}) > 0
				</when>
				<when test="searchMap.searchType eq 'content'">
					INSTR(bo_cont, #{searchMap.searchWord}) > 0
				</when>
				<when test="searchMap.searchType eq 'writer'">
					INSTR(bo_writer, #{searchMap.searchWord}) > 0
				</when>
				<otherwise>
					INSTR(bo_title, #{searchMap.searchWord}) > 0
					OR 
					INSTR(bo_cont, #{searchMap.searchWord}) > 0
					<if test="searchMap.bo_kind eq 'DM'">
						OR INSTR(bo_writer, #{searchMap.searchWord}) > 0 
					</if>
				</otherwise>
			</choose>
		</if>
	</sql>
	
	<select id="selectBoardCount" parameterType="PagingVO" resultType="int">
		SELECT COUNT(*)
		  FROM board
		 WHERE bo_kind = #{searchMap.bo_kind}
		<trim prefix="AND">
			<include refid="searchFrag"/>
		</trim>
	</select>
	
	<select id="selectBoardList" parameterType="PagingVO" resultType="BoardVO">
		SELECT *
			FROM (
			SELECT A.*, ROW_NUMBER () OVER (ORDER BY bo_write_de DESC) rn
				FROM (
					SELECT 
						(SELECT COUNT(*) FROM board WHERE bo_kind = #{searchMap.bo_kind})
						 - (ROW_NUMBER () OVER 
						(ORDER BY bo_write_de DESC)) + 1 p_bo_no,
						bo_no,
						bo_kind,
						DECODE(bo_secret_at, 'Y', '비밀글', bo_title) bo_title,
						bo_cont,
						bo_writer,
						TO_CHAR(bo_write_de, 'YYYY.MM.DD') bo_write_de, 
						bo_hit,
						bo_password, 
						bo_secret_at,
						bo_ans,
						a.univ_inqry_kind,
						b.com_code_nm inqry_kind_name 
					FROM board a
		            LEFT OUTER JOIN tb_com_code b
		            ON (a.univ_inqry_kind = b.com_code)
					WHERE bo_kind = #{searchMap.bo_kind}
					<if test="searchMap.bo_kind eq 'DM'">
		              AND b.code_grp =  (SELECT code_grp 
		                                  FROM tb_code_grp
		                                 WHERE code_grp_nm = 'UNIV_INQRY_KIND')
					</if>
				) A
		  	<trim prefix="WHERE">
		  		<include refid="searchFrag"/>
			</trim>
			)
			WHERE rn BETWEEN #{startRow} AND #{endRow}
	</select>
	
	<resultMap type="BoardVO" id="boardMap" autoMapping="true">
		<id property="bo_no" column="bo_no"/>
		<collection property="attachList" ofType="kr.ac.shms.main.commuity.vo.AttachVO" autoMapping="true">
			<id property="atch_file_no" column="atch_file_no"/>
			<id property="atch_file_seq" column="atch_file_seq"/>
		</collection>
	</resultMap>
	<select id="selectBoard" parameterType="int" resultMap="boardMap">
		SELECT
		    bo_no,
		    bo_kind,
		    bo_title,
		    bo_cont,
		    bo_writer,
		    TO_CHAR(bo_write_de, 'YYYY.MM.DD') bo_write_de,
		    bo_password,
		    bo_secret_at,
		    bo_ans,
		    bo_hit,
		    sub_code,
		    univ_inqry_kind,
		    lec_code,
		    ans_writer,
		    ans_de,
		    a.atch_file_no,
		    b.atch_file_seq,
		    b.file_nm
		FROM
		    board a
		    LEFT OUTER JOIN attach b
		    ON(a.atch_file_no = b.atch_file_no)
		WHERE bo_no = #{bo_no, jdbcType=NUMERIC}
	</select>
	
	<update id="incrementHit" parameterType="int">
		UPDATE board 
		   SET bo_hit = bo_hit + 1 
		 WHERE bo_no = #{bo_no, jdbcType=NUMERIC}
	</update>
	
	<insert id="insertBoard" parameterType="BoardVO">
		<selectKey resultType="int" keyProperty="bo_no" order="BEFORE">			
			SELECT bo_no_seq.nextval
			FROM dual
		</selectKey>
			INSERT INTO board (
			    bo_no,
			    bo_kind,
			    bo_title,
			    bo_cont,
			    bo_writer,
			    bo_write_de,
			    bo_password,
			    bo_secret_at,
			    bo_hit,
			    sub_code,
			    univ_inqry_kind,
			    lec_code
			  	<if test="atch_file_no != null">
				    ,atch_file_no
			  	</if>
			) VALUES (
			    #{bo_no},
			    #{bo_kind, jdbcType=VARCHAR},
			    #{bo_title, jdbcType=VARCHAR},
			    #{bo_cont, jdbcType=VARCHAR},
			    #{bo_writer, jdbcType=VARCHAR},
			    SYSDATE,
			    #{bo_password, jdbcType=VARCHAR},
			    #{bo_secret_at, jdbcType=VARCHAR},
			    0,
			    #{sub_code, jdbcType=VARCHAR},
			    #{univ_inqry_kind, jdbcType=VARCHAR},
			    #{lec_code, jdbcType=VARCHAR}
			    <if test="atch_file_no != null">
			    	,(SELECT MAX(atch_file_no) + 1 FROM attach)
			    </if>
			)
	</insert>
	
	<update id="updateBoard" parameterType="BoardVO">
		UPDATE board
		   SET
		    bo_kind = #{bo_kind, jdbcType=VARCHAR},
		    bo_title = #{bo_title, jdbcType=VARCHAR},
		    bo_cont = #{bo_cont, jdbcType=VARCHAR},
		    bo_writer = #{bo_writer, jdbcType=VARCHAR},
		    bo_secret_at = #{bo_secret_at, jdbcType=VARCHAR}
		WHERE bo_no = #{bo_no, jdbcType=NUMERIC}

	</update>
</mapper>