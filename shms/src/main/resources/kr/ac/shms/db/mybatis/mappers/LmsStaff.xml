<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.ac.shms.lms.staff.dao.LmsStaffDAO">
	<select id="staff" parameterType="String" resultType="kr.ac.shms.common.vo.StaffVO">
		SELECT
		    staff_no,
		    dept_code,
		    sub_code,
		    emp_section,
		    encpn_de,
		    retire_de,
		    contract_endde,
		    staff_rspofc,
		    prof_at,
		    name,
		    tel_no,
		    regno1,
		    regno2,
		    gen,
		    zipcode,
		    addr1,
		    addr2,
		    email,
		    webmail,
		    account,
		    bank_name,
		    photo_path
		FROM
		    staff
		WHERE staff_no = #{staff_no, jdbcType=VARCHAR}
	</select>
	
	<select id="selectConsltCnt" parameterType="String" resultType="int">
		SELECT
		    COUNT(*) cnt
		FROM
		    conslt_req
		WHERE staff_no = #{staff_no, jdbcType=VARCHAR}
		  AND process_stat = (SELECT COM_CODE
		                        FROM TB_COM_CODE 
		                       WHERE CODE_GRP = (SELECT CODE_GRP 
		                                           FROM TB_CODE_GRP
		                                          WHERE CODE_GRP_NM = 'PROCESS_STAT')
		                         AND COM_CODE_NM = '대기')
	</select>
	
	<select id="pmyPage" parameterType="String" resultType="PMyPageVO">
		SELECT  staff_no,
		        sub_code,
		        emp_section,
		        TO_CHAR(encpn_de, 'YYYY-MM-DD') encpn_de,
		        TO_CHAR(retire_de, 'YYYY-MM-DD') retire_de,
		        contract_endde,
		        name,
		        tel_no,
		        regno1,
		        regno2,
		        gen,
		        zipcode,
		        addr1,
		        addr2,
		        email,
		        webmail,
		        account,
		        bank_name,
		        photo_path,
		        dean_at
		FROM v_prof_info
		WHERE staff_no = #{staff_no}
	</select>
	
	<select id="subject" parameterType="String" resultType="SubjectVO">
		SELECT
		    sub_code,
		    sub_name,
		    col_code,
		    estbl_de,
		    reg_amt,
		    offrum_loc,
		    tel_no,
		    fax_no,
		    grdtn_pnt,
		    staff_no,
		    sub_index
		FROM
		    subject
		WHERE sub_code = #{sub_code}
	</select>
	
	<update id="webMailUpdate" parameterType="String">
		UPDATE staff
		    SET webmail = #{staff_no}||'@injae.ac.kr'
		WHERE
		    staff_no = #{staff_no}
	</update>
	
	<update id="mypageUpdate" parameterType="StaffVO">
		UPDATE staff
	    SET
	        bank_name = #{bank_name}
	        , account = #{account}    
	        , tel_no = #{tel_no}
	        , email = #{email}      
	        , zipcode = #{zipcode}
	        , addr1 = #{addr1}
	        , addr2 = #{addr2}
		WHERE
		    staff_no = #{staff_no}
	</update>
	
	<select id="staffMyPage" parameterType="String" resultType="SMyPageVO">
		SELECT  user_no staff_no,
				TO_CHAR(bgn_de,'YYYY-MM-DD') encpn_de,
				TO_CHAR(end_de,'YYYY-MM-DD') retire_de,
				TO_CHAR(contract_endde, 'YYYY-MM-DD') contract_endde,
		        uv.dept_code,
		        d.dept_nm, 
		        sub_code,
		        name,
		        tel_no, 
		        regno1, 
		        regno2, 
		        gen, 
		        zipcode,
		        addr1, 
		        addr2, 
		        email, 
		        webmail,
		        account,
		        bank_name,
		        photo_path,
		        rspofc
		FROM V_USERVIEW uv 
		INNER JOIN DEPT d 
		ON uv.dept_code = d.dept_code
		WHERE uv.user_no = #{user_no}
	</select>
	
	<select id="consultingList" parameterType="String" resultType="ConsultingVO">
		SELECT  req_no,
		        consult_cl,
		        b.com_code_nm consult_cl_nm,
		        req_date,
		        TO_CHAR(hope_date, 'YYYY-MM-DD') hope_date,
		        TO_CHAR(hope_date, 'HH24:MI') hope_time,
		        req_cont,
		        process_stat,
		        c.com_code_nm process_stat_nm,
		        a.stdnt_no,
                st.name,
		        refuse_resn,
		        a.staff_no,
                d.name staff_name,
		        conslt_link
		FROM
		    conslt_req a
		INNER JOIN tb_com_code b
		ON(a.consult_cl = b.com_code)
		INNER JOIN tb_com_code c
		ON(a.process_stat = c.com_code)
        INNER JOIN staff d
        ON (a.staff_no = d.staff_no)
        INNER JOIN student st
        ON (a.stdnt_no = st.stdnt_no)
		WHERE b.code_grp = (SELECT code_grp FROM tb_code_grp WHERE code_grp_nm = 'CONSULT_CL')
		  AND c.code_grp = (SELECT code_grp FROM tb_code_grp WHERE code_grp_nm = 'PROCESS_STAT')
		  AND d.staff_no = #{staff_no}
	</select>
	
	<update id="consultingCompanion" parameterType="ConsultingVO">
		UPDATE CONSLT_REQ SET
		    process_stat = 'BR',
		    refuse_resn = #{refuse_resn}
		WHERE req_no = #{req_no}	
	</update>
	
	<update id="consultingApproval" parameterType="int">
		UPDATE CONSLT_REQ SET
		    process_stat = 'SI'
		WHERE req_no = #{req_no}
	</update>
	
</mapper>