<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.ac.shms.lms.student.dao.CertificateDAO">
	<select id="selectCrtfList" resultType="CertificateReqVO" parameterType="string">
		SELECT *
		  FROM (
		  SELECT A.*, ROW_NUMBER () OVER (ORDER BY req_de DESC) rn
		    FROM (
		        SELECT 
		            (SELECT COUNT(*) FROM crtf_req WHERE stdnt_no = #{stdnt_no, jdbcType=VARCHAR}  )
		             - (ROW_NUMBER () OVER 
		            (ORDER BY req_de DESC))+1 p_bo_no,
		            req_no,
		            TO_CHAR(req_de, 'YYYY.MM.DD') req_de,
		            no_of_issue,
		           (SELECT com_code_nm
		              FROM tb_com_code
		             WHERE CODE_GRP = (SELECT CODE_GRP FROM TB_CODE_GRP WHERE CODE_GRP_NM = 'CRTF_KIND')
		               AND com_code = crtf_kind) crtf_kind,
		          crtf_req_resn
		         FROM crtf_req 
		        WHERE stdnt_no = #{stdnt_no, jdbcType=VARCHAR}  
		    ) A
		 )
	</select>
	
	<select id="selectCrtf" parameterType="CertificateReqVO" resultType="CertificateReqVO">
		SELECT (SELECT com_code_nm
		          FROM tb_com_code
		         WHERE CODE_GRP = (SELECT CODE_GRP FROM TB_CODE_GRP WHERE CODE_GRP_NM = 'CRTF_KIND')
		           AND com_code = crtf_kind) crtf_kind,
		       crtf_price,
		       no_of_issue,
		       sub_name
	  FROM crtf_req a
	 INNER JOIN student b ON(a.stdnt_no=b.stdnt_no)
	 INNER JOIN subject c ON(b.sub_code=c.sub_code)
	 WHERE req_no = #{req_no, jdbcType=NUMERIC}
	   AND a.stdnt_no=#{stdnt_no, jdbcType=VARCHAR}  
	</select>
	
	<select id="selectCrtfKind" resultType="String" parameterType="String">
		 SELECT com_code_nm
		   FROM tb_com_code
		  WHERE CODE_GRP = (SELECT CODE_GRP FROM TB_CODE_GRP WHERE CODE_GRP_NM = 'CRTF_KIND')
		    AND com_code = #{crtf_req_resn, jdbcType=VARCHAR}
	</select>
	
	<select id="selectCrtfReqResn" resultType="String" parameterType="String">
		 SELECT com_code_nm
		   FROM tb_com_code
		  WHERE CODE_GRP = (SELECT CODE_GRP FROM TB_CODE_GRP WHERE CODE_GRP_NM = 'CRTF_REQ_RESN')
		    AND com_code = #{crtf_kind, jdbcType=VARCHAR}
	</select>
	<select id="selectReginfoCount" parameterType="String" resultType="int">
		SELECT  COUNT(req_cl_code)
		  FROM reginfo_cng
		 WHERE stdnt_no=#{stdnt_no, jdbcType=VARCHAR}
		   AND req_cl_code=#{crtf_kind, jdbcType=VARCHAR} 
		   AND process_stat='SI'
	</select>
	
	<insert id="insertCrtfReq" parameterType="CertificateReqVO">
		INSERT INTO crtf_req (
		    req_no,
		    stdnt_no,
		    req_de,
		    crtf_req_resn,
		    crtf_kind,
		    crtf_price,
		    no_of_issue
		) VALUES (
		    CRTF_REQ_SEQ.NEXTVAL,
		    #{stdnt_no, jdbcType=VARCHAR},
		    SYSDATE,
		    #{crtf_req_resn, jdbcType=VARCHAR},
		    #{crtf_kind, jdbcType=VARCHAR},
		    #{crtf_price, jdbcType=NUMERIC},
		    #{no_of_issue, jdbcType=NUMERIC}
		)
	</insert>
</mapper>














