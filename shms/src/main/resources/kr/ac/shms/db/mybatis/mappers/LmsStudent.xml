<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.ac.shms.lms.student.dao.StudentDAO">
	<select id="student" parameterType="String" resultType="kr.ac.shms.lms.student.vo.StudentVO">
		SELECT stdnt_no,
		       sub_code,
		       entsch_de,
		       grdtn_de,
		       empmnt_at,
		       grade, 
		       name,
		       tel_no,
		       regno1,
		       regno2,
		       gen, 
		       zipcode, 
		       addr1,
		       addr2,
		       email,
		       webmail,
		       account,
		       bank_name,
		       photo_path,
		       semstr
		FROM student
		WHERE stdnt_no = #{stdnt_no, jdbcType=VARCHAR}
	</select>
	
	<sql id="loanCntFrag">
		FROM
		    book_loan
		where stdnt_no = #{stdnt_no, jdbcType=VARCHAR}
		  AND return_dt IS NULL
	</sql>
	
	<select id="bookLoanCnt" parameterType="String" resultType="hashMap">
		SELECT bookLoancnt, expiredcnt
		  FROM (
		SELECT
		    COUNT(*) bookLoancnt
		<include refid="loanCntFrag"></include>
		),
		(SELECT 
		    COUNT(*) expiredcnt
		<include refid="loanCntFrag"></include>
		<![CDATA[
		  AND return_exp_dt < SYSDATE)
		]]>
	</select>
	
	<update id="webMailUpdate" parameterType="String">
		UPDATE student
		    SET webmail = #{stdnt_no}||'@injae.ac.kr'
		WHERE
		    stdnt_no = #{stdnt_no}
	</update>
	
	<select id="subject" parameterType="String" resultType="SubjectVO">
		SELECT  sub_code,
		        sub_name,
		        col_code,
		        estbl_de,
		        reg_amt,
		        offrum_loc,
		        tel_no,
		        fax_no,
		        grdtn_pnt,
		        staff_no,
		        sub_index
		FROM subject
		WHERE sub_code = (
		    SELECT sub_code
		    FROM student
		    WHERE stdnt_no = #{stdnt_no}
		)
	</select>
	<select id="regInfo" parameterType="String" resultType="RegInfoCngVO">
		SELECT  cng_req_no,
		        stdnt_no,
		        req_de,
		        process_stat,
		        proc_date,
		        refuse_resn,
		        atch_file_no,
		        req_cl_code,
		        req_resn_code,
		        cng_bgnde,
		        cng_endde
		FROM (
		    SELECT  cng_req_no,
		            stdnt_no,
		            req_de,
		            process_stat,
		            proc_date,
		            refuse_resn,
		            atch_file_no,
		            req_cl_code,
		            req_resn_code,
		            cng_bgnde,
		            cng_endde
		    FROM reginfo_cng
		    WHERE stdnt_no = 'S19101001'
		    AND PROCESS_STAT = 'SI'
		    ORDER BY proc_date DESC
		)
		WHERE ROWNUM = 1
	</select>
	
</mapper>

